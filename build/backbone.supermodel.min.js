// Backbone.Supermodel
// v1.1.6
//
// Copyright (c)2014 Tan Nguyen
// Distributed under MIT license
//
Backbone.SuperModel=function(a,b){var c=function(b){return a.isString(b)&&(b=b.split(".")),b},d=function(a,b,d){b=c(b);for(var e=b.length,f=0;e>f;f++){if(!a||"object"!=typeof a)return d;a=a[b[f]]}return void 0===a?d:a},e=function(a,b,d){b=c(b),lastKeyIndex=b.length-1;for(var e=0;lastKeyIndex>e;++e)key=b[e],key in a||(a[key]={}),a=a[key];d(a,b[lastKeyIndex])},f=function(a,b,c){e(a,b,function(a,b){a[b]=c})},g=function(a,b){e(a,b,function(a,b){delete a[b]})},h=function(b,c){var d=!1;return e(b,c,function(b,c){d=a.has(b,c)}),d},i=function(d,e,f){e=c(e);var g=a.first(e),h=d.get(g);h instanceof b.Model?i(h,a.rest(e),f):f(d,e)},j=b.Model.extend({relations:{},unsafeAttributes:[],name:null,_getRelation:function(b,c){var d;if(b){var e=a.result(this,"relations");d=e[b]}return c&&!d&&(d=j),"undefined"==typeof d&&(d=j),d},_setupBackref:function(b){var c=a.result(this,"name");return c&&!b[c]&&(b[c]=this),b},_valueForCollection:function(b){return a.isArray(b)?b.length>=1?a.isObject(b[0]):!0:!1},_nestedSet:function(c,d,e){c=c.split(".");for(var f=c.length-1,g=this,h=0;f>h;++h){var i=c[h],j=g.attributes[i];if(!j){var l=this._getRelation(i,d),m=new l;g.attributes[i]=this._setupBackref(m,e)}g=g.attributes[i]}var n=c[f];if(!a.isArray(d)&&a.isObject(d))for(var o in d){var p=n+"."+o;g._nestedSet(p,d[o],e)}else if(this._valueForCollection(d)){var q=this._getRelation(n,d);q.prototype instanceof b.Model&&(q=k);var r=new q(d);r=this._setupBackref(r,e),g.attributes[n]=r}else 1==c.length?g.attributes[n]=d:g.set(n,d,{skipNested:!0,forceChange:!0})},_setChanging:function(){this._previousAttributes=this.toJSON(),this.changed={}},_triggerChanges:function(a,b,c){a.length&&(this._pending=!0);for(var d=0,e=a.length;e>d;d++)c||(c=this.get(a[d])),this.trigger("change:"+a[d],this,c,b)},_setChange:function(b,c,d){var e=this.get(b);return b=b.split("."),!a.isEqual(e,c)||d.forceChange?(f(this.changed,b,c),!0):(g(this.changed,b),!1)},set:function(a,b,c){var d,e,f,g,h,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={},e[a]=b),c=c||{},!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],j=this._changing,k=c.skipNested,this._changing=!0,j||this._setChanging(),this.idAttribute in e&&(this.id=e[this.idAttribute]);var l=function(a,b){delete a.attributes[b]};for(d in e)b=e[d],this._setChange(d,b,c)&&g.push(d),f?i(this,d,l):k?this.attributes[d]=b:this._nestedSet(d,b,c);if(h||this._triggerChanges(g,c),j)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},get:function(b){var c=b.split(".");if(c.length>1){var d=this.attributes[a.first(c)];if(!d)return;var e=a.rest(c).join(".");return a.isFunction(d.get)?d.get(e):d[e]}return this.attributes[b]},toJSON:function(){var b=(a.result(this,"unsafeAttributes"),a.clone(this.attributes));return a.each(this.unsafeAttributes,function(a){delete b[a]}),a.each(b,function(c,d){c&&a.isFunction(c.toJSON)&&(b[d]=c.toJSON())}),b},hasChanged:function(b){return null==b?!a.isEmpty(this.changed):h(this.changed,b)},previous:function(a){return null!=a&&this._previousAttributes?d(this._previousAttributes,a):null}}),k=b.Collection.extend({model:j});return j}(_,Backbone);