// Backbone.Supermodel
// v1.1.5
//
// Copyright (c)2014 Tan Nguyen
// Distributed under MIT license
//
!function(a,b){if("object"==typeof exports){var c=require("underscore"),d=require("backbone");module.exports=b(c,d)}else"function"==typeof define&&define.amd&&define(["underscore","backbone"],b)}(this,function(a,b){return b.SuperModel=function(a,b){var c=function(b){return a.isString(b)&&(b=b.split(".")),b},d=function(a,b,d){b=c(b);for(var e=b.length,f=0;e>f;f++){if(!a||"object"!=typeof a)return d;a=a[b[f]]}return void 0===a?d:a},e=function(a,b,d){b=c(b),lastKeyIndex=b.length-1;for(var e=0;lastKeyIndex>e;++e)key=b[e],key in a||(a[key]={}),a=a[key];d(a,b[lastKeyIndex])},f=function(a,b,c){e(a,b,function(a,b){a[b]=c})},g=function(a,b){e(a,b,function(a,b){delete a[b]})},h=function(b,c){var d=!1;return e(b,c,function(b,c){d=a.has(b,c)}),d},i=function(d,e,f){e=c(e);var g=a.first(e),h=d.get(g);h instanceof b.Model?i(h,a.rest(e),f):f(d,e)},j=b.Model.extend({relations:{},unsafeAttributes:[],name:null,_getRelation:function(b,c){var d;if(b){var e=a.result(this,"relations");d=e[b]}return c&&!d&&(d=this._valueForCollection(c)?k:j),"undefined"==typeof d&&(d=j),d},_setupBackref:function(b){var c=a.result(this,"name");return c&&!b[c]&&(b[c]=this),b},_valueForCollection:function(b){return a.isArray(b)?b.length>=1?a.isObject(b[0]):!0:!1},_nestedSet:function(b,c,d){b=b.split(".");for(var e=b.length-1,f=this,g=0;e>g;++g){var h=b[g],i=f.attributes[h];if(!i){var j=this._getRelation(h,c),k=new j;f.attributes[h]=this._setupBackref(k,d)}f=f.attributes[h]}var l=b[e];if(!a.isArray(c)&&a.isObject(c))for(var m in c){var n=l+"."+m;f._nestedSet(n,c[m],d)}else if(this._valueForCollection(c)){var o=f.attributes[l];if(!o){var p=this._getRelation(l,c);o=new p,f.attributes[l]=this._setupBackref(o,d)}o.add(c)}else 1==b.length?f.attributes[l]=c:f.set(l,c,{skipNested:!0,forceChange:!0})},_setChanging:function(){this._previousAttributes=this.toJSON(),this.changed={}},_triggerChanges:function(a,b,c){a.length&&(this._pending=!0);for(var d=0,e=a.length;e>d;d++)c||(c=this.get(a[d])),this.trigger("change:"+a[d],this,c,b)},_setChange:function(b,c,d){var e=this.get(b);return b=b.split("."),!a.isEqual(e,c)||d.forceChange?(f(this.changed,b,c),!0):(g(this.changed,b),!1)},set:function(a,b,c){var d,e,f,g,h,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={},e[a]=b),c=c||{},!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],j=this._changing,k=c.skipNested,this._changing=!0,j||this._setChanging(),this.idAttribute in e&&(this.id=e[this.idAttribute]);var l=function(a,b){delete a.attributes[b]};for(d in e)b=e[d],this._setChange(d,b,c)&&g.push(d),f?i(this,d,l):k?this.attributes[d]=b:this._nestedSet(d,b,c);if(h||this._triggerChanges(g,c),j)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},get:function(b){var c=b.split(".");if(c.length>1){var d=this.attributes[a.first(c)];if(!d)return;var e=a.rest(c).join(".");return a.isFunction(d.get)?d.get(e):d[e]}return this.attributes[b]},toJSON:function(){var b=(a.result(this,"unsafeAttributes"),a.clone(this.attributes));return a.each(this.unsafeAttributes,function(a){delete b[a]}),a.each(b,function(c,d){c&&a.isFunction(c.toJSON)&&(b[d]=c.toJSON())}),b},hasChanged:function(b){return null==b?!a.isEmpty(this.changed):h(this.changed,b)},previous:function(a){return null!=a&&this._previousAttributes?d(this._previousAttributes,a):null}}),k=b.Collection.extend({model:j});return j}(a,b),b.SuperModel});